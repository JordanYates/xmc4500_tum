=================================================
--------------------- INFO ----------------------
=================================================

Files and instructions relating to the 'Embedded Systems and Security' Course offered at the
Technical University of Munich

=================================================
---- HOW TO ADD USB FUNCTIONALITY TO PROJECT ----
=================================================

1. 
Download LUFA USB library from Infineon
http://www.infineon.com/cms/en/product/microcontroller/32-bit-industrial-microcontroller-based-on-arm-registered-cortex-registered-m/xmc-development-tools-software-tools-and-partner/software-downloads/channel.html?channel=db3a30433b47825b013b4b9e224a0de6

2. 
Modify file 'USB/Core/XMC4000/Endpoint_XMC4000.c' line 43, from
#include "../USBmode.h"
to
#include "../USBMode.h"
and line 47,
#include "../EndPoint.h"
to
#include "../Endpoint.h"

3.
Rename file 'USB/Core/EndPoint.h' to 'Endpoint.h'

4.
Copy the 'USB' folder to your project folder

5.
Replace the default makefile with the makefile found here
https://github.com/JordanYates/xmc4500_tum

6.
Copy the 'VirtualSerial' and 'Descriptors' files from 'Examples/Device/VirtualSerial' to your project directory.

7.
In main.c, add
#include "VirtualSerial.h"

at the start of main() add:

	XMC_SCU_CLOCK_EnableUsbPll();
	XMC_SCU_CLOCK_StartUsbPll(2, 64);
	XMC_SCU_CLOCK_SetUsbClockDivider(4);
	XMC_SCU_CLOCK_SetUsbClockSource(XMC_SCU_CLOCK_USBCLKSRC_USBPLL);
	XMC_SCU_CLOCK_EnableClock(XMC_SCU_CLOCK_USB);

	SystemCoreClockUpdate();
	USB_Init();

8.
To print strings:

	CDC_Device_SendString(&VirtualSerial_CDC_Interface, "TEST STRING");
	CDC_Device_USBTask(&VirtualSerial_CDC_Interface);
	USB_USBTask();

=================================================
--------------- printf Functionality ------------
=================================================
Clone the following repository:
https://github.com/cjlano/tinyprintf
Copy tinyprintf.c and tinyprintf.h into project directory

Add the following lines to the top of your main.c

	#include "tinyprintf.h"

	#define debug_printf(fmt, args);		printf((fmt), (args)); \
												CDC_Device_USBTask(&VirtualSerial_CDC_Interface); \
												USB_USBTask();

	void tiny_putc(void* p, char c)
	{
		CDC_Device_SendByte(&VirtualSerial_CDC_Interface, (const uint8_t)c);
	}

After calling USB_init() add:
	init_printf(NULL, tiny_putc);

Formatted prints can then be sent, with some restriction in types (see tinyprintf.h)
	debug_printf("Test String: %u %u\r\n", count++, count + 1);

debug_printf can obviously be renamed through the #define, but not to printf, as 'stdio.h' is included in the USB driver.

=================================================
------------- Displaying Received Data ----------
=================================================

Displaying the transmitted data simply requires running the following command.

cat /dev/ttyACM0

=================================================
----------------- Further Info ------------------
=================================================

More advanced functionality can be implemented by looking at the 'USB/Class/Device/CDCClassDevice.h' file.
